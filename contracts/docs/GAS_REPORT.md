# AgentFICOScore Gas Report

## Overview

가스 비용 분석 리포트 (Foundry gas-report 기반)  
**생성일**: 2025-01-29  
**테스트 결과**: 46/46 테스트 통과

## 측정 환경

- **Solidity**: 0.8.20
- **Optimizer**: enabled (200 runs)
- **Network**: Base (L2)
- **Deployment Cost**: 1,523,319 gas
- **Contract Size**: 6,777 bytes

## 함수별 가스 비용

### Write Functions

| Function | Min Gas | Avg Gas | Median Gas | Max Gas | Notes |
|----------|---------|---------|------------|---------|-------|
| `updateScore()` | 26,005 | 442,177 | 453,180 | 453,264 | 신규 에이전트: ~453K, 업데이트: ~26K |
| `transferOwnership()` | 23,795 | 27,029 | 28,596 | 28,596 | 관리자 함수 |

> **참고**: `updateScore()`의 Min Gas (26,005)는 입력 검증 실패 시의 가스 소비입니다.  
> 신규 에이전트 등록 시 ~453K gas, 기존 에이전트 업데이트 시에도 스토리지 히스토리 저장으로 인해 비슷한 가스가 소비됩니다.

### Read Functions (view)

| Function | Min Gas | Avg Gas | Notes |
|----------|---------|---------|-------|
| `getScore()` | 2,785 | 17,530 | 전체 Score struct 반환 (7개 필드) |
| `getScoreOnly()` | 2,623 | 4,810 | overall 값만 반환 (가스 최적화) |
| `assessRisk()` | 3,039 | 18,998 | 리스크 평가 (동적 배열 생성) |
| `isRegistered()` | 2,597 | 2,597 | 단순 storage 조회 |
| `getTotalAgents()` | 2,270 | 2,270 | 단순 storage 조회 |
| `getScoreHistory()` | 2,903 | 27,809 | 히스토리 배열 반환 (limit에 따라 변동) |
| `owner()` | 2,424 | 2,424 | public variable getter |
| `lastUpdate()` | 2,527 | 2,527 | public mapping getter |
| `totalAgents()` | 2,350 | 2,350 | public variable getter |

### getScore() vs getScoreOnly() 비교

| 함수 | 평균 가스 | 절감량 |
|------|----------|--------|
| `getScore()` | 17,530 | - |
| `getScoreOnly()` | 4,810 | **-72.6%** |

> 💡 **권장**: overall 점수만 필요한 경우 `getScoreOnly()` 사용으로 ~12,720 gas 절약

## Base Mainnet 비용 추정

### 가정

- **Base L2 Gas Price**: 0.001 gwei (L2 특성상 매우 저렴, 실제로는 0.000001~0.01 gwei 범위)
- **ETH Price**: $3,000 USD
- **updateScore() 가스**: 453,264 gas (신규/업데이트 시)

### 단일 트랜잭션 비용

```
Gas Cost = 453,264 gas × 0.001 gwei = 0.000000453264 ETH
USD Cost = 0.000000453264 × $3,000 = $0.00000136
```

> ⚠️ **실제 Base L2 가스 가격**은 0.000001~0.01 gwei 범위로 변동됩니다.  
> 보수적으로 0.01 gwei를 사용하면 트랜잭션당 약 **$0.0000136** 입니다.

### 월간 비용 예측 (600 agents)

#### 시나리오 1: 보수적 추정 (Gas Price: 0.01 gwei)

| 시나리오 | 트랜잭션 수 | 총 가스 | 예상 비용 |
|----------|------------|---------|----------|
| 모든 에이전트 신규 등록 (1회) | 600 | 271,958,400 | **$0.0082** |
| 일일 1회 업데이트 (30일) | 18,000 | 8,158,752,000 | **$0.2448** |
| 일일 4회 업데이트 (30일) | 72,000 | 32,635,008,000 | **$0.9792** |

#### 시나리오 2: 중간 추정 (Gas Price: 0.1 gwei)

| 시나리오 | 트랜잭션 수 | 총 가스 | 예상 비용 |
|----------|------------|---------|----------|
| 모든 에이전트 신규 등록 (1회) | 600 | 271,958,400 | **$0.082** |
| 일일 1회 업데이트 (30일) | 18,000 | 8,158,752,000 | **$2.45** |
| 일일 4회 업데이트 (30일) | 72,000 | 32,635,008,000 | **$9.79** |

#### 시나리오 3: 최악의 경우 (Gas Price: 1 gwei)

| 시나리오 | 트랜잭션 수 | 총 가스 | 예상 비용 |
|----------|------------|---------|----------|
| 모든 에이전트 신규 등록 (1회) | 600 | 271,958,400 | **$0.82** |
| 일일 1회 업데이트 (30일) | 18,000 | 8,158,752,000 | **$24.48** |
| 일일 4회 업데이트 (30일) | 72,000 | 32,635,008,000 | **$97.92** |

### 비용 결론

| 조건 | 월간 예상 비용 | 목표 ($5 이하) |
|------|---------------|----------------|
| 보수적 (0.01 gwei), 일 1회 업데이트 | ~$0.25 | ✅ 달성 |
| 중간 (0.1 gwei), 일 1회 업데이트 | ~$2.45 | ✅ 달성 |
| 최악 (1 gwei), 일 1회 업데이트 | ~$24.48 | ❌ 초과 |

> **결론**: Base L2의 일반적인 가스 가격(0.001~0.1 gwei)에서 **월 $5 이하 목표 달성 가능**.  
> 단, 가스 가격이 급등하는 경우(1 gwei 이상)에는 목표 초과 가능성 있음.

## 현재 최적화 상태

### ✅ 적용된 최적화

1. **Custom Errors 사용**
   - `NotOwner()`, `AgentNotRegistered()`, `ScoreOutOfRange()` 등
   - require + string 대비 가스 절약

2. **가시성 최적화**
   - 적절한 `external` vs `public` 사용
   - 불필요한 public getter 제거

3. **Storage 최적화**
   - `calldata` 사용 (string parameters)
   - Memory allocation 최소화

4. **getScoreOnly() 함수 제공**
   - 전체 struct 대신 단일 값만 반환
   - 72.6% 가스 절약

5. **Optimizer 활성화**
   - 200 runs로 설정
   - 읽기/쓰기 균형 최적화

### 🔄 추가 최적화 가능 (선택적)

1. **Struct Packing** (현재 미적용)
   ```solidity
   // 현재: 각 필드가 별도 슬롯 사용
   struct Score {
       uint256 overall;          // slot 0
       uint256 txSuccess;        // slot 1
       ...
   }
   
   // 최적화: uint128/uint64 사용 시 슬롯 절약 가능
   // 단, 점수 범위(0-1000)에는 과도한 최적화
   ```

2. **History 저장 방식 변경**
   - 현재: 모든 히스토리 on-chain 저장
   - 대안: 최근 N개만 저장 (Ring Buffer)
   - 예상 절감: 신규 에이전트 시 30-50%

3. **Event 기반 히스토리**
   - History 조회를 이벤트 기반으로 변경
   - Storage 비용 대폭 절감 가능
   - 단점: 조회 시 indexer 필요

4. **immutable owner** (보안 고려 필요)
   - `owner` 변수를 immutable로 변경 시 읽기 비용 절감
   - 단, ownership transfer 불가능

## 결론

### 핵심 수치

| 항목 | 값 |
|------|-----|
| 배포 비용 | 1,523,319 gas |
| updateScore (신규) | ~453,264 gas |
| updateScore (업데이트) | ~453,180 gas |
| getScoreOnly | ~4,810 gas |
| getScore | ~17,530 gas |

### 비용 효율성

- **Base L2 환경**에서 매우 경제적으로 운영 가능
- **일반적인 가스 가격**에서 **월 $5 이하 목표 충족**
- `getScoreOnly()` 활용으로 읽기 비용 72% 절감 가능

### 권장 사항

1. **프로토콜 통합 시** `getScoreOnly()` 우선 사용 권장
2. **가스 스파이크 대비** 업데이트 빈도 조절 메커니즘 고려
3. **대규모 확장 시** 히스토리 저장 방식 최적화 검토

---

*Generated by Foundry forge test --gas-report*
