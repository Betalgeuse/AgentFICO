# AgentFICO - Milestone M2: Score Calculation Engine

## Overview
| Field | Value |
|:---|:---|
| **Milestone ID** | M2-score-calculation |
| **Title** | Score Calculation Engine |
| **Status** | ✅ Completed |
| **Start Date** | 2026-01-29 |
| **Target Date** | 2026-02-07 |
| **Priority** | **HIGH** (M1 선행 조건) |
| **Linear Label** | `milestone:M2` |
| **Linear Team** | `web3` |

## Why M2 First?
> 참조: [ADR-002](../../adr/ADR-002-deployment-order.md)
> 
> 온체인 컨트랙트는 수정 불가. 점수 공식을 충분히 검증한 후 배포해야 신뢰 유지.

## Goals
- 점수 계산 로직 구현 및 검증
- 데이터 소스 연동 (Etherscan API)
- 실제 에이전트 데이터로 백테스트
- 점수 공식 확정 (40-40-20 가중치 검증)

## Non-Goals
- 스마트 컨트랙트 배포 (M1, 이 마일스톤 완료 후)
- DeFi 프로토콜 통합 (M3)
- 프론트엔드 대시보드 (M4)

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                    Score Calculation Engine                     │
│                                                                 │
│  ┌──────────────────┐  ┌──────────────────┐  ┌───────────────┐│
│  │ Etherscan API    │  │ x402 Protocol    │  │ ERC-8004      ││
│  │ (txSuccess)      │  │ (profitability)  │  │ (stability)   ││
│  └────────┬─────────┘  └────────┬─────────┘  └───────┬───────┘│
│           │                     │                     │        │
│           └─────────────┬───────┴─────────────────────┘        │
│                         ▼                                       │
│           ┌─────────────────────────────┐                      │
│           │    Score Calculator         │                      │
│           │  • txSuccess (40%)          │                      │
│           │  • x402Profitability (40%)  │                      │
│           │  • erc8004Stability (20%)   │                      │
│           └──────────────┬──────────────┘                      │
│                          ▼                                      │
│           ┌─────────────────────────────┐                      │
│           │    AgentFICO Score (0-1000) │                      │
│           └─────────────────────────────┘                      │
└─────────────────────────────────────────────────────────────────┘
```

## Phase 0: Linear 이슈 등록

### TASK-000: Linear 프로젝트 초기화
```yaml
task_id: M2-000
title: "Linear 이슈 등록"
droid: linear-project-manager
priority: critical
depends_on: []
team: web3

instructions: |
  1. Linear web3 팀에 M2 이슈 등록
  2. Label 생성:
     - milestone:M2
     - phase:0, phase:1, phase:2, phase:3
     - type:api, type:data, type:test
  3. 모든 TASK를 Linear Issue로 등록
  4. 의존성 설정

deliverables:
  - Linear에 모든 이슈 등록 완료
  - 각 TASK에 linear_issue_id 추가
```

## Phase 1: 데이터 소스 연동

### TASK-001: Etherscan API 연동
```yaml
task_id: M2-001
title: "Etherscan API 클라이언트 구현"
droid: web3-api-developer
priority: critical
depends_on: []

instructions: |
  ## 목표
  에이전트의 트랜잭션 성공률(txSuccess) 데이터 수집
  
  ## 구현 내용
  1. Etherscan API 클라이언트 클래스
  2. 에이전트 주소별 트랜잭션 히스토리 조회
  3. 트랜잭션 성공/실패 분석
  4. Rate limiting 처리 (5 calls/sec)
  
  ## API 엔드포인트
  - txlist: 일반 트랜잭션
  - txlistinternal: 내부 트랜잭션
  - tokentx: ERC-20 전송
  
  ## 디렉토리 구조
  api/
  ├── src/
  │   ├── data_sources/
  │   │   └── etherscan.py
  │   └── models/
  │       └── transaction.py

deliverables:
  - api/src/data_sources/etherscan.py
  - api/src/models/transaction.py
  - 단위 테스트

acceptance_criteria:
  - [ ] API 호출 성공
  - [ ] 트랜잭션 성공률 계산 정확
  - [ ] Rate limiting 동작
```

### TASK-002: x402 Protocol 데이터 연동
```yaml
task_id: M2-002
title: "x402 Protocol 수익성 데이터"
droid: web3-api-developer
priority: high
depends_on: [M2-001]

instructions: |
  ## 목표
  에이전트의 x402 프로토콜 수익성(profitability) 데이터 수집
  
  ## 구현 내용
  1. x402 Payment 이벤트 조회
  2. 에이전트별 수익/지출 분석
  3. ROI 계산 로직
  
  ## 데이터 소스
  - 온체인 이벤트 로그
  - x402 결제 컨트랙트

deliverables:
  - api/src/data_sources/x402.py
  - 수익성 계산 로직

acceptance_criteria:
  - [ ] x402 이벤트 파싱 성공
  - [ ] 수익성 지표 계산
```

### TASK-003: ERC-8004 안정성 지표 (모킹)
```yaml
task_id: M2-003
title: "ERC-8004 안정성 지표"
droid: web3-api-developer
priority: medium
depends_on: []

instructions: |
  ## 목표
  에이전트의 ERC-8004 기반 안정성 지표 계산
  
  ## 현재 상태
  ERC-8004 표준 미확정으로 모킹 데이터 사용
  
  ## 구현 내용
  1. 안정성 지표 인터페이스 정의
  2. 모킹 데이터 생성기
  3. 실제 데이터 연동 시 교체 가능한 구조

deliverables:
  - api/src/data_sources/erc8004.py
  - api/src/data_sources/erc8004_mock.py

acceptance_criteria:
  - [ ] 인터페이스 정의
  - [ ] 모킹 데이터 생성
```

## Phase 2: 점수 계산 엔진

### TASK-004: Score Calculator 구현
```yaml
task_id: M2-004
title: "점수 계산 엔진 핵심 로직"
droid: web3-api-developer
priority: critical
depends_on: [M2-001, M2-002, M2-003]

instructions: |
  ## 목표
  AgentFICO 점수 계산 로직 구현
  
  ## 계산 공식 (검증 필요)
  overall = txSuccess * 0.4 + x402Profitability * 0.4 + erc8004Stability * 0.2
  
  ## 입력값 (각 0-100)
  - txSuccess: 트랜잭션 성공률
  - x402Profitability: 수익성 지표
  - erc8004Stability: 안정성 지표
  
  ## 출력값
  - overall: 0-1000 (입력값 * 10)
  - riskLevel: 1-5
  - confidence: 0-100
  
  ## 리스크 레벨 매핑
  1: Excellent (850+)
  2: Good (750-849)
  3: Average (650-749)
  4: Below Average (550-649)
  5: Poor (<550)

deliverables:
  - api/src/calculator/score_calculator.py
  - 단위 테스트

acceptance_criteria:
  - [ ] 점수 계산 정확
  - [ ] 리스크 레벨 매핑 정확
  - [ ] 엣지 케이스 처리
```

### TASK-005: 백테스트 프레임워크
```yaml
task_id: M2-005
title: "점수 공식 백테스트"
droid: blockchain-data-analyzer
priority: high
depends_on: [M2-004]

instructions: |
  ## 목표
  실제 에이전트 데이터로 점수 공식 검증
  
  ## 백테스트 시나리오
  1. 알려진 "좋은" 에이전트 → 높은 점수?
  2. 알려진 "나쁜" 에이전트 → 낮은 점수?
  3. 가중치 변경 시 분포 변화
  
  ## 테스트 데이터셋
  - 최소 10개 에이전트 주소
  - 다양한 활동 패턴 포함
  
  ## 출력
  - 점수 분포 히스토그램
  - 가중치별 민감도 분석

deliverables:
  - api/src/backtest/backtest_runner.py
  - 백테스트 결과 리포트

acceptance_criteria:
  - [ ] 점수 분포 합리적
  - [ ] 가중치 민감도 문서화
```

## Phase 3: REST API

### TASK-006: FastAPI 엔드포인트
```yaml
task_id: M2-006
title: "Score API 엔드포인트"
droid: web3-api-developer
priority: high
depends_on: [M2-004]

instructions: |
  ## 목표
  점수 조회 REST API 구현
  
  ## 엔드포인트
  GET /score/{agent_address}
  - 에이전트 점수 조회
  - 응답: Score 객체
  
  GET /score/{agent_address}/history
  - 점수 이력 조회
  
  POST /score/{agent_address}/refresh
  - 점수 재계산 트리거
  
  ## 응답 형식
  {
    "overall": 780,
    "txSuccess": 85,
    "x402Profitability": 72,
    "erc8004Stability": 68,
    "riskLevel": 2,
    "confidence": 95,
    "timestamp": "2026-01-29T12:00:00Z"
  }

deliverables:
  - api/src/routes/score.py
  - OpenAPI 문서

acceptance_criteria:
  - [ ] 모든 엔드포인트 동작
  - [ ] 에러 핸들링
  - [ ] API 문서화
```

### TASK-007: 점수 공식 확정 및 문서화
```yaml
task_id: M2-007
title: "점수 공식 확정"
droid: blockchain-data-analyzer
priority: critical
depends_on: [M2-005, M2-006]

instructions: |
  ## 목표
  백테스트 결과 기반 최종 점수 공식 확정
  
  ## 작업 내용
  1. 백테스트 결과 분석
  2. 가중치 최적화 (필요시)
  3. ADR 작성: 점수 공식 결정 근거
  4. TECH_SPEC 업데이트
  
  ## 결정 사항
  - 최종 가중치 (현재 40-40-20)
  - 리스크 레벨 threshold
  - confidence 계산 방식

deliverables:
  - docs/adr/ADR-003-score-formula.md
  - docs/AGENTFICO_TECH_SPEC.md 업데이트

acceptance_criteria:
  - [ ] 점수 공식 확정
  - [ ] ADR 문서화
  - [ ] M1 재개 조건 충족
```

## Droid Assignment

| Task | Droid | Reason |
|:---|:---|:---|
| M2-000 | linear-project-manager | Linear 이슈 관리 |
| M2-001 | web3-api-developer | Etherscan API 연동 |
| M2-002 | web3-api-developer | x402 데이터 연동 |
| M2-003 | web3-api-developer | ERC-8004 인터페이스 |
| M2-004 | web3-api-developer | 점수 계산 엔진 |
| M2-005 | blockchain-data-analyzer | 백테스트 분석 |
| M2-006 | web3-api-developer | REST API 구현 |
| M2-007 | blockchain-data-analyzer | 공식 확정 |

## Cost Estimate

| Item | Cost |
|:---|:---|
| Etherscan API | Free tier (5 calls/sec) |
| 서버 운영 | ~$20/month (AWS t3.small) |
| 개발 기간 | 7-10일 |

## Timeline

| Day | Tasks | Milestone |
|:---|:---|:---|
| Day 1-2 | M2-000 ~ M2-003 | 데이터 소스 연동 |
| Day 3-4 | M2-004 ~ M2-005 | 점수 계산 + 백테스트 |
| Day 5-7 | M2-006 ~ M2-007 | API + 공식 확정 |

## Success Criteria

- [x] 모든 데이터 소스 연동
- [x] 점수 계산 로직 구현
- [x] 백테스트 통과 (정확도 75%)
- [x] 점수 공식 확정 (ADR-003)
- [x] REST API 동작
- [x] **M1 재개 조건 충족**

## M1 재개 조건

M2 완료 후 M1 (온체인 배포) 재개 조건:
1. ✅ 점수 공식 확정 (ADR-003)
2. ✅ 백테스트 통과 (합리적 점수 분포)
3. ✅ API로 점수 조회 가능
4. ✅ 팀 리뷰 완료

## References

- [ADR-002](../../adr/ADR-002-deployment-order.md) - M2 우선 개발 결정
- [AGENTFICO_TECH_SPEC](../../business-context/specs/AGENTFICO_TECH_SPEC.md) - 기술 명세
- [Etherscan API Docs](https://docs.etherscan.io)
