# AgentFICO - Milestone M5: Anti-Gaming Scoring System

## Overview
| Field | Value |
|:---|:---|
| **Milestone ID** | M5-anti-gaming |
| **Title** | Anti-Gaming 점수 시스템 |
| **Status** | 📋 Planned |
| **Depends On** | M3 (Real Agent Scoring) |
| **Estimated Duration** | 2-3주 |

## Why Anti-Gaming?

### 문제: 공식 공개 시 게이밍 가능
```
현재 공개된 정보:
- 가중치: tx_success 40%, x402 40%, erc8004 20%
- 계산 로직: ADR-002에 명시
- 데이터 소스: Etherscan, x402, ERC-8004 Registry

게이밍 시나리오:
1. "tx_success 40%니까 작은 성공 트랜잭션만 대량 생성"
2. "erc8004_stability 20%니까 메타데이터만 완벽하게 채우기"
3. 실제 성능과 무관하게 점수만 조작 가능
```

### 실제 FICO의 접근법
```
FICO는 정확한 공식을 비공개로 유지:
- 대략적인 카테고리만 공개 (payment history ~35%)
- 정확한 가중치, 보정 계수, 임계값은 비공개
- 정기적으로 모델 업데이트
- 이상 패턴 탐지 시스템 운영
```

### AgentFICO 딜레마
```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   투명성 (Web3 가치)  ◄────────────►  기밀성 (게이밍 방지)     │
│                                                                 │
│   "공식을 공개해야               "공식을 숨겨야                │
│    신뢰할 수 있다"                게이밍을 막는다"             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

해결책: 기본 공식은 공개 + Anti-Gaming 레이어 추가
```

---

## Goals

1. **게이밍 탐지**: 점수 조작 시도를 감지하는 시스템
2. **동적 가중치**: 시간/맥락에 따라 변하는 보정 계수
3. **이상 탐지**: 급격한 행동 변화 감지 및 페널티
4. **히스토리 기반**: 단기 조작으로 점수 급등 불가

## Non-Goals

- ZK Proof 시스템 (불필요로 판단됨)
- 완전한 공식 비공개 (Web3 투명성과 충돌)
- 실시간 온체인 계산 (가스 비용)

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                  Anti-Gaming Scoring System                     │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    Layer 1: Base Score                    │  │
│  │                                                           │  │
│  │   tx_success × 0.40 + x402 × 0.40 + erc8004 × 0.20       │  │
│  │                        ↓                                  │  │
│  │                   Raw Score (공개)                        │  │
│  └───────────────────────────────────────────────────────────┘  │
│                            ↓                                    │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                Layer 2: Anti-Gaming Adjustments           │  │
│  │                                                           │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │  │
│  │  │ Time Decay  │  │ Anomaly     │  │ Consistency     │   │  │
│  │  │ Factor      │  │ Detection   │  │ Bonus           │   │  │
│  │  │             │  │             │  │                 │   │  │
│  │  │ 최근 vs     │  │ 급격한      │  │ 장기간 안정적  │   │  │
│  │  │ 과거 가중   │  │ 변화 탐지   │  │ 성과 보상      │   │  │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘   │  │
│  │                        ↓                                  │  │
│  │              Adjusted Score (비공개 계수)                 │  │
│  └───────────────────────────────────────────────────────────┘  │
│                            ↓                                    │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                Layer 3: Final Score                       │  │
│  │                                                           │  │
│  │   min(1000, max(0, adjusted_score))                      │  │
│  │                        ↓                                  │  │
│  │              AgentFICO Score (0-1000)                     │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Anti-Gaming 전략

### 1. Time Decay Factor (시간 감쇠)
```python
# 최근 활동에 더 높은 가중치
def apply_time_decay(transactions: list) -> float:
    """
    - 최근 7일: 100% 가중치
    - 7-30일: 70% 가중치  
    - 30-90일: 40% 가중치
    - 90일+: 20% 가중치
    
    → 과거 좋은 기록만으로 점수 유지 불가
    → 지속적인 좋은 성과 필요
    """
```

**게이밍 방지 효과:**
- "예전에 잘했으니까 지금 대충해도 돼" 불가
- 지속적인 좋은 성과 유지 필요

### 2. Anomaly Detection (이상 탐지)
```python
def detect_anomaly(agent: str, new_data: dict) -> float:
    """
    급격한 변화 탐지:
    - 트랜잭션 수 급증 (3σ 이상)
    - 성공률 급변 (±20% 이상)
    - 활동 패턴 변화 (시간대, 빈도)
    
    이상 탐지 시:
    - 경고 플래그 설정
    - 점수 상승 제한 (최대 +50/week)
    - 관찰 기간 적용 (2주)
    """
```

**게이밍 방지 효과:**
- 점수 올리려고 갑자기 트랜잭션 대량 생성 → 탐지됨
- 급격한 행동 변화 → 의심 플래그

### 3. Consistency Bonus (일관성 보너스)
```python
def calculate_consistency_bonus(history: list) -> float:
    """
    장기간 안정적 성과에 보너스:
    - 30일 연속 성공률 80%+ → +20점
    - 90일 연속 성공률 80%+ → +50점
    - 180일 연속 성공률 80%+ → +100점
    
    → 단기 조작으로 얻을 수 없는 점수
    """
```

**게이밍 방지 효과:**
- 6개월 이상 좋은 성과 유지해야 최고 점수 가능
- 단기 조작의 ROI 낮춤

### 4. Transaction Quality Score (트랜잭션 품질)
```python
def assess_transaction_quality(tx: dict) -> float:
    """
    모든 트랜잭션이 동등하지 않음:
    
    고품질 (가중치 높음):
    - 실제 DeFi 상호작용
    - 의미 있는 금액 (>$10)
    - 다양한 프로토콜
    
    저품질 (가중치 낮음):
    - 자기 자신에게 전송
    - 더스트 금액 (<$0.01)
    - 동일 컨트랙트 반복
    """
```

**게이밍 방지 효과:**
- 더스트 트랜잭션 스팸 → 효과 없음
- 실제 유의미한 활동만 인정

### 5. Sybil Resistance (시빌 저항)
```python
def check_sybil_patterns(agent: str) -> float:
    """
    시빌 공격 패턴 탐지:
    - 동일 자금 소스에서 파생된 지갑들
    - 동시간대 동일 패턴 트랜잭션
    - 상호 전송 링 구조
    
    탐지 시:
    - 관련 에이전트 모두 페널티
    - 클러스터로 묶어서 평가
    """
```

---

## 공개 vs 비공개 정보

| 항목 | 공개 | 비공개 | 이유 |
|:-----|:----:|:------:|:-----|
| 기본 가중치 (40-40-20) | ✅ | | 투명성 |
| Time Decay 존재 여부 | ✅ | | 투명성 |
| Time Decay 정확한 계수 | | ✅ | 게이밍 방지 |
| Anomaly 탐지 기준 | | ✅ | 게이밍 방지 |
| Consistency Bonus 존재 | ✅ | | 장기 성과 유도 |
| Consistency 정확한 임계값 | | ✅ | 게이밍 방지 |
| Quality Score 기준 | | ✅ | 게이밍 방지 |

**원칙: "무엇을 측정하는지는 공개, 어떻게 측정하는지는 비공개"**

---

## Tasks

### TASK-001: Time Decay 구현
```yaml
task_id: M5-001
title: "시간 기반 가중치 시스템"
droid: web3-api-developer
priority: critical

instructions: |
  api/src/services/anti_gaming/time_decay.py 구현
  - 트랜잭션 타임스탬프 기반 가중치 계산
  - 설정 가능한 decay 곡선
  - 단위 테스트

acceptance_criteria:
  - [ ] 시간대별 가중치 적용
  - [ ] 기존 점수 계산과 통합
```

### TASK-002: Anomaly Detection 구현
```yaml
task_id: M5-002
title: "이상 탐지 시스템"
droid: web3-api-developer
priority: critical

instructions: |
  api/src/services/anti_gaming/anomaly_detector.py 구현
  - 통계적 이상치 탐지 (Z-score, IQR)
  - 행동 패턴 변화 감지
  - 경고 플래그 시스템

acceptance_criteria:
  - [ ] 급격한 변화 탐지
  - [ ] 경고 플래그 DB 저장
```

### TASK-003: Consistency Bonus 구현
```yaml
task_id: M5-003
title: "일관성 보너스 시스템"
droid: web3-api-developer
priority: high

instructions: |
  api/src/services/anti_gaming/consistency.py 구현
  - 히스토리 기반 보너스 계산
  - 연속 기간 추적
  - 보너스 상한 설정

acceptance_criteria:
  - [ ] 30/90/180일 보너스 계산
  - [ ] 히스토리 저장 및 조회
```

### TASK-004: Transaction Quality 구현
```yaml
task_id: M5-004
title: "트랜잭션 품질 평가"
droid: blockchain-data-analyzer
priority: high

instructions: |
  api/src/services/anti_gaming/tx_quality.py 구현
  - 트랜잭션 유형 분류
  - 금액 기반 가중치
  - 프로토콜 다양성 평가

acceptance_criteria:
  - [ ] 트랜잭션 품질 점수 (0-100)
  - [ ] DeFi 프로토콜 인식
```

### TASK-005: Anti-Gaming 통합
```yaml
task_id: M5-005
title: "기존 점수 엔진과 통합"
droid: web3-api-developer
priority: critical
depends_on: [M5-001, M5-002, M5-003, M5-004]

instructions: |
  api/src/services/score_engine.py 업데이트
  - Layer 1 (Base Score) + Layer 2 (Anti-Gaming) 통합
  - Feature flag로 on/off 가능
  - A/B 테스트 지원

acceptance_criteria:
  - [ ] 기존 API 호환성 유지
  - [ ] Anti-Gaming 적용 점수 반환
```

### TASK-006: 백테스트 및 검증
```yaml
task_id: M5-006
title: "Anti-Gaming 효과 검증"
droid: blockchain-data-analyzer
priority: high
depends_on: [M5-005]

instructions: |
  scripts/backtest_anti_gaming.py 작성
  - 시뮬레이션된 게이밍 시나리오 테스트
  - 정상 에이전트 영향 최소화 확인
  - 게이밍 시도 탐지율 측정

acceptance_criteria:
  - [ ] 게이밍 탐지율 > 80%
  - [ ] 정상 에이전트 점수 변화 < 5%
```

---

## Timeline

| Week | Tasks | Deliverable |
|:-----|:------|:------------|
| Week 1 | M5-001, M5-002 | Time Decay, Anomaly Detection |
| Week 2 | M5-003, M5-004 | Consistency, TX Quality |
| Week 3 | M5-005, M5-006 | 통합, 백테스트 |

---

## Success Criteria

- [ ] 게이밍 시나리오 탐지율 > 80%
- [ ] 정상 에이전트 점수 영향 < 5%
- [ ] 기존 API 100% 호환
- [ ] 응답 시간 증가 < 100ms

---

## ADR Reference

이 마일스톤의 결정 배경:
- ZK Proof는 불필요 (입력 데이터가 이미 공개)
- 게이밍 방지가 핵심 문제
- 투명성과 기밀성의 균형 필요

---

## References

- [ADR-002: Score Formula](../../adr/ADR-002-score-formula.md)
- [FICO Score Gaming Prevention](https://www.myfico.com/)
- [Sybil Resistance in DeFi](https://vitalik.ca/general/2021/09/26/limits.html)
