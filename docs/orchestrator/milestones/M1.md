# AgentFICO - Milestone M1: Smart Contract 배포

## ⚠️ Blocked Notice
> **이 마일스톤은 M2 완료 후 진행합니다.**
> 
> 이유: 점수 계산 공식이 확정되지 않은 상태에서 온체인 배포 시 재배포 리스크 발생
> 
> 참조: [ADR-002](../../adr/ADR-002-deployment-order.md)

## Current Progress (2026-01-29)
- [x] M1-001: Foundry 프로젝트 세팅
- [x] M1-002: AgentFICOScore.sol 구현
- [x] M1-003: 단위 테스트 (46개 통과)
- [x] M1-004: 배포 스크립트 작성
- [ ] M1-005: Base Sepolia 배포 ← **BLOCKED**
- [ ] M1-006: Base Mainnet 배포 ← **BLOCKED**
- [ ] M1-007: 배포 문서화 ← **BLOCKED**

## Overview
| Field | Value |
|:---|:---|
| **Milestone ID** | M1-smart-contract-deployment |
| **Title** | Smart Contract 배포 (Foundry + Base) |
| **Status** | ⏸️ Blocked (M2 대기) |
| **Start Date** | 2026-01-29 |
| **Target Date** | 2026-01-31 |
| **Linear Label** | `milestone:M1` |
| **Linear Team** | `web3` |

## Goals
- Foundry 프로젝트 세팅
- AgentFICOScore.sol 스마트 컨트랙트 구현
- Base Sepolia 테스트넷 배포 및 테스트
- Base Mainnet 배포
- Basescan 컨트랙트 검증

## Non-Goals
- REST API 구현 (M2)
- DeFi 프로토콜 통합 (M3)
- 프론트엔드 대시보드 (M4)
- ERC-8004 연동 (표준 확정 후)

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                    AgentFICO Smart Contract                     │
│                                                                 │
│  Network: Base (Coinbase L2)                                   │
│  - Mainnet: Chain ID 8453                                      │
│  - Sepolia: Chain ID 84532                                     │
│                                                                 │
│  RPC Endpoints:                                                │
│  - Mainnet: https://mainnet.base.org                           │
│  - Sepolia: https://sepolia.base.org                           │
│                                                                 │
│  Explorer:                                                      │
│  - Mainnet: https://basescan.org                               │
│  - Sepolia: https://sepolia.basescan.org                       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    AgentFICOScore.sol                           │
│  ├── updateScore(agent, scores)  - 점수 업데이트 (owner only)  │
│  ├── getScore(agent)             - 점수 조회 (view)            │
│  ├── getScoreOnly(agent)         - 종합점수만 조회 (gas 최적화)│
│  ├── assessRisk(agent, amount)   - 리스크 평가 (view)          │
│  └── getScoreHistory(agent)      - 점수 이력 조회              │
└─────────────────────────────────────────────────────────────────┘
```

## Phase 0: Linear 이슈 등록

### TASK-000: Linear 프로젝트 초기화
```yaml
task_id: M1-000
title: "Linear 이슈 등록"
droid: linear-project-manager
priority: critical
depends_on: []
team: web3

instructions: |
  1. Linear web3 팀에 이슈 등록
  2. Label 생성:
     - milestone:M1
     - phase:0, phase:1, phase:2, phase:3
     - type:contract, type:test, type:deploy
  3. 모든 TASK를 Linear Issue로 등록
  4. 의존성 설정

deliverables:
  - Linear에 모든 이슈 등록 완료
  - 각 TASK에 linear_issue_id 추가
```

## Phase 1: Foundry 프로젝트 설정

### TASK-001: Foundry 프로젝트 초기화
```yaml
task_id: M1-001
title: "Foundry 프로젝트 세팅"
droid: web3-smart-contract-auditor
priority: critical
depends_on: []

instructions: |
  ## 목표
  Foundry 기반 스마트 컨트랙트 개발 환경 구축
  
  ## 설치 및 초기화
  1. forge init contracts
  2. OpenZeppelin 의존성 설치
  3. foundry.toml 설정 (Base 네트워크)
  4. remappings.txt 설정
  
  ## Base 네트워크 설정
  - Mainnet RPC: https://mainnet.base.org
  - Sepolia RPC: https://sepolia.base.org
  - Chain ID Mainnet: 8453
  - Chain ID Sepolia: 84532
  
  ## 디렉토리 구조
  contracts/
  ├── src/
  │   └── AgentFICOScore.sol
  ├── test/
  │   └── AgentFICOScore.t.sol
  ├── script/
  │   └── Deploy.s.sol
  ├── foundry.toml
  └── .env.example

deliverables:
  - contracts/ 디렉토리 구조
  - foundry.toml (Base 네트워크 설정 포함)
  - .env.example

acceptance_criteria:
  - [ ] forge build 성공
  - [ ] forge test 실행 가능
```

### TASK-002: AgentFICOScore.sol 구현
```yaml
task_id: M1-002
title: "AgentFICOScore 핵심 계약"
droid: web3-smart-contract-auditor
priority: critical
depends_on: [M1-001]

instructions: |
  ## 목표
  techspec 기반 AgentFICOScore 컨트랙트 구현
  
  ## 핵심 구조체
  1. Score 구조체
     - overall (0-1000)
     - txSuccess (40% weight)
     - x402Profitability (40% weight)  
     - erc8004Stability (20% weight)
     - confidence, riskLevel, timestamp, ipfsBreakdown
  
  2. RiskAssessment 구조체
     - riskLevel, defaultProbability, expectedLoss
     - positiveFactors, riskFactors
  
  ## 핵심 함수
  1. updateScore() - owner만 호출 가능
  2. getScore() - 전체 Score 반환
  3. getScoreOnly() - overall만 반환 (가스 최적화)
  4. assessRisk() - 리스크 평가
  5. getScoreHistory() - 이력 조회
  
  ## 보안 요구사항
  - onlyOwner modifier
  - 입력값 검증 (0-100 범위)
  - 이벤트 발행

deliverables:
  - contracts/src/AgentFICOScore.sol

acceptance_criteria:
  - [ ] 모든 함수 구현
  - [ ] 보안 modifier 적용
  - [ ] NatSpec 문서화
  - [ ] forge build 성공
```

### TASK-003: AgentFICOScore 테스트
```yaml
task_id: M1-003
title: "AgentFICOScore 단위 테스트"
droid: web3-smart-contract-auditor
priority: high
depends_on: [M1-002]

instructions: |
  ## 테스트 케이스
  1. 점수 업데이트 테스트
     - 정상 업데이트
     - owner 아닌 주소에서 호출 시 revert
     - 잘못된 점수 범위 (>100) revert
  
  2. 점수 조회 테스트
     - getScore() 정상 반환
     - getScoreOnly() 가스 효율 확인
     - 미등록 에이전트 조회 시 revert
  
  3. 리스크 평가 테스트
     - assessRisk() 정상 동작
     - 프로토콜 타입별 계산
  
  4. 이력 조회 테스트
     - 여러 번 업데이트 후 이력 확인
  
  5. 가스 벤치마크
     - updateScore 가스 측정
     - getScore vs getScoreOnly 비교

deliverables:
  - contracts/test/AgentFICOScore.t.sol

acceptance_criteria:
  - [ ] 모든 테스트 통과
  - [ ] forge test -vvv 성공
  - [ ] 가스 리포트 확인
```

## Phase 2: Base Sepolia 테스트넷 배포

### TASK-004: 배포 스크립트 작성
```yaml
task_id: M1-004
title: "Foundry 배포 스크립트"
droid: web3-smart-contract-auditor
priority: high
depends_on: [M1-003]

instructions: |
  ## 배포 스크립트 작성
  script/Deploy.s.sol 작성
  
  ## 환경 변수
  - PRIVATE_KEY: 배포 지갑 개인키
  - RPC_URL: Base Sepolia/Mainnet RPC
  - ETHERSCAN_API_KEY: Basescan API 키 (검증용)
  
  ## 배포 명령어
  # Sepolia
  forge script script/Deploy.s.sol --rpc-url $BASE_SEPOLIA_RPC --broadcast --verify
  
  # Mainnet  
  forge script script/Deploy.s.sol --rpc-url $BASE_MAINNET_RPC --broadcast --verify

deliverables:
  - contracts/script/Deploy.s.sol
  - contracts/.env.example 업데이트

acceptance_criteria:
  - [ ] 스크립트 문법 오류 없음
  - [ ] 시뮬레이션 성공 (--dry-run)
```

### TASK-005: Base Sepolia 배포
```yaml
task_id: M1-005
title: "Base Sepolia 테스트넷 배포"
droid: web3-smart-contract-auditor
priority: high
depends_on: [M1-004]

instructions: |
  ## 사전 준비
  1. MetaMask에 Base Sepolia 네트워크 추가
     - RPC: https://sepolia.base.org
     - Chain ID: 84532
     - Symbol: ETH
     - Explorer: https://sepolia.basescan.org
  
  2. Faucet에서 테스트 ETH 수령
     - https://www.coinbase.com/faucets/base-ethereum-sepolia-faucet
  
  ## 배포 실행
  cd contracts
  source .env
  forge script script/Deploy.s.sol \
    --rpc-url https://sepolia.base.org \
    --broadcast \
    --verify
  
  ## 검증
  1. 배포된 컨트랙트 주소 기록
  2. Basescan에서 컨트랙트 확인
  3. Read/Write 함수 테스트

deliverables:
  - 배포된 컨트랙트 주소 (Sepolia)
  - Basescan 검증 완료
  - 테스트 트랜잭션 해시

acceptance_criteria:
  - [ ] 컨트랙트 배포 성공
  - [ ] Basescan에서 verified
  - [ ] updateScore 테스트 트랜잭션 성공
  - [ ] getScore 조회 성공
```

## Phase 3: Base Mainnet 배포

### TASK-006: Base Mainnet 배포
```yaml
task_id: M1-006
title: "Base Mainnet 프로덕션 배포"
droid: web3-smart-contract-auditor
priority: critical
depends_on: [M1-005]

instructions: |
  ## 사전 준비
  1. MetaMask에 Base Mainnet 네트워크 확인
     - RPC: https://mainnet.base.org
     - Chain ID: 8453
     - Symbol: ETH
     - Explorer: https://basescan.org
  
  2. 가스비용 확인 (~$0.50-1.00 for deploy)
  
  ## 배포 실행
  cd contracts
  source .env
  forge script script/Deploy.s.sol \
    --rpc-url https://mainnet.base.org \
    --broadcast \
    --verify
  
  ## 배포 후 작업
  1. 컨트랙트 주소 문서화
  2. Basescan 검증 확인
  3. 초기 에이전트 점수 등록 테스트
  4. techspec 업데이트 (컨트랙트 주소)

deliverables:
  - 배포된 컨트랙트 주소 (Mainnet)
  - Basescan 검증 완료
  - docs/AGENTFICO_TECH_SPEC.md 업데이트

acceptance_criteria:
  - [ ] 컨트랙트 배포 성공
  - [ ] Basescan에서 verified
  - [ ] techspec에 컨트랙트 주소 기록
```

### TASK-007: 배포 문서화
```yaml
task_id: M1-007
title: "배포 결과 문서화"
droid: web3-smart-contract-auditor
priority: medium
depends_on: [M1-006]

instructions: |
  ## 문서 작성
  docs/DEPLOYMENT.md 작성
  
  ## 포함 내용
  1. 네트워크 정보
  2. 컨트랙트 주소 (Sepolia, Mainnet)
  3. 배포 트랜잭션 해시
  4. ABI 파일 위치
  5. 사용 방법 예시 (ethers.js, viem)

deliverables:
  - docs/DEPLOYMENT.md
  - contracts/out/AgentFICOScore.sol/AgentFICOScore.json (ABI)

acceptance_criteria:
  - [ ] 모든 배포 정보 문서화
  - [ ] ABI 파일 접근 가능
```

## Droid Assignment

| Task | Droid | Reason |
|:---|:---|:---|
| M1-000 | linear-project-manager | Linear 이슈 관리 (web3 팀) |
| M1-001 | web3-smart-contract-auditor | Foundry 세팅 |
| M1-002 | web3-smart-contract-auditor | 핵심 계약 구현 |
| M1-003 | web3-smart-contract-auditor | 테스트 작성 |
| M1-004 | web3-smart-contract-auditor | 배포 스크립트 |
| M1-005 | web3-smart-contract-auditor | Sepolia 배포 |
| M1-006 | web3-smart-contract-auditor | Mainnet 배포 |
| M1-007 | web3-smart-contract-auditor | 문서화 |

## Cost Estimate

| Item | Cost |
|:---|:---|
| Base Sepolia 배포 | Free (testnet) |
| Base Mainnet 배포 | ~$0.50-1.00 |
| 월간 updateScore (600 agents) | ~$1-5 |

## Timeline

| Day | Tasks | Milestone |
|:---|:---|:---|
| Day 1 | M1-000 ~ M1-002 | Linear 등록, Foundry 세팅, 계약 구현 |
| Day 2 | M1-003 ~ M1-005 | 테스트, 배포 스크립트, Sepolia 배포 |
| Day 3 | M1-006 ~ M1-007 | Mainnet 배포, 문서화 |

## Success Criteria

- [ ] Foundry 프로젝트 정상 빌드
- [ ] 모든 테스트 통과
- [ ] Base Sepolia 배포 및 검증 완료
- [ ] Base Mainnet 배포 및 검증 완료
- [ ] 컨트랙트 주소 techspec에 기록
- [ ] 모든 Linear 이슈 Done

## References

- [Base Documentation](https://docs.base.org)
- [Foundry Book](https://book.getfoundry.sh)
- [Basescan](https://basescan.org)
- [docs/AGENTFICO_TECH_SPEC.md](../../../AGENTFICO_TECH_SPEC.md)
